<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Farm Finance - Generate Report</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="p-4">
    <div class="container">
      <h2>Farm Finance Report</h2>
      <form id="reportForm" method="POST" action="/generate-pdf">
        <div class="mb-3">
          <label class="form-label">Farmer Name</label>
          <input name="farmer_name" class="form-control" required />
        </div>

        <div class="row">
          <div class="col">
            <label class="form-label">Crop Name</label>
            <input name="crop_name" class="form-control" required />
          </div>
          <div class="col">
            <label class="form-label">Season (Kharif, Rabi, Zaid)</label>
            <input name="season" class="form-control" required />
          </div>
        </div>

        <div class="row mt-2">
          <div class="col">
            <label class="form-label">Total Acres</label>
            <input
              name="total_acres"
              type="number"
              step="0.01"
              class="form-control"
              required
            />
          </div>

          <div class="col">
            <label class="form-label">Total Production (optional)</label>
            <input
              name="total_production"
              type="number"
              step="0.01"
              class="form-control"
              placeholder="e.g. 5.0"
            />
          </div>

          <div class="col">
            <label class="form-label"
              >Location (Village/Taluka/District/State)</label
            >
            <input name="location" class="form-control" required />
          </div>
        </div>

        <div class="row mt-2">
          <div class="col">
            <label class="form-label">Date of Sowing</label>
            <input
              name="sowing_date"
              type="date"
              class="form-control"
              required
            />
          </div>
          <div class="col">
            <label class="form-label">Date of Harvest</label>
            <input
              name="harvest_date"
              type="date"
              class="form-control"
              required
            />
          </div>
        </div>

        <hr />

        <h5>Expenses</h5>
        <table class="table" id="expensesTable">
          <thead>
            <tr>
              <th>Category</th>
              <th>Amount</th>
              <th>Date</th>
              <th>Description</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button
          class="btn btn-sm btn-outline-primary"
          type="button"
          onclick="addExpenseRow()"
        >
          Add Expense
        </button>

        <hr />

        <h5>Incomes</h5>
        <table class="table" id="incomesTable">
          <thead>
            <tr>
              <th>Category</th>
              <th>Amount</th>
              <th>Date</th>
              <th>Description</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button
          class="btn btn-sm btn-outline-primary"
          type="button"
          onclick="addIncomeRow()"
        >
          Add Income
        </button>

        <input type="hidden" name="expenses_json" id="expenses_json" />
        <input type="hidden" name="incomes_json" id="incomes_json" />

        <div class="mt-4">
          <button type="submit" class="btn btn-success">Generate PDF</button>
        </div>
      </form>
    </div>

    <script>
      function addExpenseRow(data = {}) {
        const tbody = document.querySelector("#expensesTable tbody");
        const tr = document.createElement("tr");
        tr.innerHTML = `
        <td><input class="form-control" name="exp_cat" value="${
          data.category || ""
        }" /></td>
        <td><input class="form-control" name="exp_amt" type="number" step="0.01" value="${
          data.amount || ""
        }" /></td>
        <td><input class="form-control" name="exp_date" type="date" value="${
          data.date || ""
        }" /></td>
        <td><input class="form-control" name="exp_desc" value="${
          data.description || ""
        }" /></td>
        <td><button type="button" class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">Remove</button></td>
      `;
        tbody.appendChild(tr);
      }
      function addIncomeRow(data = {}) {
        const tbody = document.querySelector("#incomesTable tbody");
        const tr = document.createElement("tr");
        tr.innerHTML = `
        <td><input class="form-control" name="inc_cat" value="${
          data.category || ""
        }" /></td>
        <td><input class="form-control" name="inc_amt" type="number" step="0.01" value="${
          data.amount || ""
        }" /></td>
        <td><input class="form-control" name="inc_date" type="date" value="${
          data.date || ""
        }" /></td>
        <td><input class="form-control" name="inc_desc" value="${
          data.description || ""
        }" /></td>
        <td><button type="button" class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">Remove</button></td>
      `;
        tbody.appendChild(tr);
      }

      addExpenseRow();
      addIncomeRow();

      document
        .getElementById("reportForm")
        .addEventListener("submit", function (e) {
          const exp_rows = [];
          document.querySelectorAll("#expensesTable tbody tr").forEach((tr) => {
            const cat = tr.querySelector('[name="exp_cat"]').value;
            const amt = parseFloat(
              tr.querySelector('[name="exp_amt"]').value || 0
            );
            const date = tr.querySelector('[name="exp_date"]').value;
            const desc = tr.querySelector('[name="exp_desc"]').value;
            if (cat && date) {
              exp_rows.push({
                category: cat,
                amount: amt,
                date: date,
                description: desc,
              });
            }
          });

          const inc_rows = [];
          document.querySelectorAll("#incomesTable tbody tr").forEach((tr) => {
            const cat = tr.querySelector('[name="inc_cat"]').value;
            const amt = parseFloat(
              tr.querySelector('[name="inc_amt"]').value || 0
            );
            const date = tr.querySelector('[name="inc_date"]').value;
            const desc = tr.querySelector('[name="inc_desc"]').value;
            if (cat && date) {
              inc_rows.push({
                category: cat,
                amount: amt,
                date: date,
                description: desc,
              });
            }
          });

          document.getElementById("expenses_json").value =
            JSON.stringify(exp_rows);
          document.getElementById("incomes_json").value =
            JSON.stringify(inc_rows);
        });
    </script>
  </body>
</html>
